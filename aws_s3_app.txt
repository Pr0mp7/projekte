## Directory Structure:
```
aws_s3/
├── Dockerfile
├── requirements.txt
├── api.yaml
└── src/
    └── app.py
```

## Dockerfile:
```dockerfile
# For airgapped environment - use your local registry
ARG LOCAL_REGISTRY=your-registry.local:5000
FROM ${LOCAL_REGISTRY}/shuffle/app_sdk:0.0.25 AS base

FROM base
WORKDIR /app

# Install shuffle_sdk first
RUN pip3 install --no-cache-dir shuffle_sdk==0.0.18

# Install boto3 and dependencies without version conflicts
RUN pip3 install --no-cache-dir --no-deps \
    boto3==1.26.137 \
    botocore==1.29.137 \
    s3transfer==0.6.1 \
    jmespath==1.0.1 \
    python-dateutil==2.8.2 \
    six==1.16.0

# Copy app source code
COPY src /app

# No import fixes needed since we're writing it correctly from the start

CMD ["python", "app.py", "--log-level", "DEBUG"]
```

## requirements.txt:
```txt
shuffle_sdk==0.0.18
boto3==1.26.137
botocore==1.29.137
s3transfer==0.6.1
jmespath==1.0.1
python-dateutil==2.8.2
```

## api.yaml:
```yaml
app_version: 1.0.0
name: AWS S3
description: AWS S3 and MinIO compatible storage operations
tags:
  - Storage
  - AWS
  - MinIO
  - S3
categories:
  - Storage
contact_info:
  name: "@shuffle"
  url: https://shuffler.io
  email: support@shuffler.io
authentication:
  required: false
  parameters: []
docker_version: 1.0.0
actions:
  - name: list_buckets
    description: List all S3 buckets
    node_type: action
    parameters:
      - name: access_key
        description: AWS/MinIO Access Key
        required: true
        multiline: false
        example: "AKIAIOSFODNN7EXAMPLE"
        schema:
          type: string
      - name: secret_key
        description: AWS/MinIO Secret Key
        required: true
        multiline: false
        example: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
        schema:
          type: string
      - name: region
        description: AWS Region (use us-east-1 for MinIO)
        required: true
        multiline: false
        example: "us-east-1"
        schema:
          type: string
      - name: endpoint_url
        description: Custom endpoint URL (for MinIO - e.g. http://minio:9000)
        required: false
        multiline: false
        example: "http://minio:9000"
        schema:
          type: string
    returns:
      schema:
        type: string
  
  - name: create_bucket
    description: Create a new S3 bucket
    node_type: action
    parameters:
      - name: access_key
        description: AWS/MinIO Access Key
        required: true
        schema:
          type: string
      - name: secret_key
        description: AWS/MinIO Secret Key
        required: true
        schema:
          type: string
      - name: region
        description: AWS Region
        required: true
        example: "us-east-1"
        schema:
          type: string
      - name: bucket_name
        description: Name of the bucket to create
        required: true
        example: "my-bucket"
        schema:
          type: string
      - name: access_type
        description: Bucket ACL
        required: true
        example: "private"
        schema:
          type: string
      - name: endpoint_url
        description: Custom endpoint URL (for MinIO)
        required: false
        schema:
          type: string
    returns:
      schema:
        type: string
  
  - name: upload_file_to_bucket
    description: Upload a file to S3 bucket
    node_type: action
    parameters:
      - name: access_key
        description: AWS/MinIO Access Key
        required: true
        schema:
          type: string
      - name: secret_key
        description: AWS/MinIO Secret Key
        required: true
        schema:
          type: string
      - name: region
        description: AWS Region
        required: true
        schema:
          type: string
      - name: bucket_name
        description: Target bucket name
        required: true
        example: "my-bucket"
        schema:
          type: string
      - name: bucket_path
        description: Path/key in bucket
        required: true
        example: "folder/file.txt"
        schema:
          type: string
      - name: file_id
        description: Shuffle file ID to upload
        required: true
        example: "$file_id"
        schema:
          type: string
      - name: endpoint_url
        description: Custom endpoint URL (for MinIO)
        required: false
        schema:
          type: string
    returns:
      schema:
        type: string
  
  - name: download_file_from_bucket
    description: Download a file from S3 bucket
    node_type: action
    parameters:
      - name: access_key
        description: AWS/MinIO Access Key
        required: true
        schema:
          type: string
      - name: secret_key
        description: AWS/MinIO Secret Key
        required: true
        schema:
          type: string
      - name: region
        description: AWS Region
        required: true
        schema:
          type: string
      - name: bucket_name
        description: Source bucket name
        required: true
        schema:
          type: string
      - name: filename
        description: File path/key in bucket
        required: true
        example: "folder/file.txt"
        schema:
          type: string
      - name: endpoint_url
        description: Custom endpoint URL (for MinIO)
        required: false
        schema:
          type: string
    returns:
      schema:
        type: string
  
  - name: delete_file_from_bucket
    description: Delete a file from S3 bucket
    node_type: action
    parameters:
      - name: access_key
        description: AWS/MinIO Access Key
        required: true
        schema:
          type: string
      - name: secret_key
        description: AWS/MinIO Secret Key
        required: true
        schema:
          type: string
      - name: region
        description: AWS Region
        required: true
        schema:
          type: string
      - name: bucket_name
        description: Bucket name
        required: true
        schema:
          type: string
      - name: bucket_path
        description: File path/key to delete
        required: true
        schema:
          type: string
      - name: endpoint_url
        description: Custom endpoint URL (for MinIO)
        required: false
        schema:
          type: string
    returns:
      schema:
        type: string

  - name: block_ip_access
    description: Block IP access to bucket (AWS only, not MinIO)
    node_type: action
    parameters:
      - name: access_key
        description: AWS Access Key
        required: true
        schema:
          type: string
      - name: secret_key
        description: AWS Secret Key
        required: true
        schema:
          type: string
      - name: region
        description: AWS Region
        required: true
        schema:
          type: string
      - name: bucket_name
        description: Bucket name
        required: true
        schema:
          type: string
      - name: ip
        description: IP address to block
        required: true
        example: "192.168.1.100"
        schema:
          type: string
      - name: endpoint_url
        description: Custom endpoint URL
        required: false
        schema:
          type: string
    returns:
      schema:
        type: string

  - name: bucket_logging
    description: Get bucket logging configuration
    node_type: action
    parameters:
      - name: access_key
        description: AWS/MinIO Access Key
        required: true
        schema:
          type: string
      - name: secret_key
        description: AWS/MinIO Secret Key
        required: true
        schema:
          type: string
      - name: region
        description: AWS Region
        required: true
        schema:
          type: string
      - name: bucket_name
        description: Bucket name
        required: true
        schema:
          type: string
      - name: endpoint_url
        description: Custom endpoint URL (for MinIO)
        required: false
        schema:
          type: string
    returns:
      schema:
        type: string

  - name: bucket_policy_status
    description: Get bucket policy status
    node_type: action
    parameters:
      - name: access_key
        description: AWS/MinIO Access Key
        required: true
        schema:
          type: string
      - name: secret_key
        description: AWS/MinIO Secret Key
        required: true
        schema:
          type: string
      - name: region
        description: AWS Region
        required: true
        schema:
          type: string
      - name: bucket_name
        description: Bucket name
        required: true
        schema:
          type: string
      - name: endpoint_url
        description: Custom endpoint URL (for MinIO)
        required: false
        schema:
          type: string
    returns:
      schema:
        type: string

  - name: bucket_replication
    description: Get bucket replication configuration
    node_type: action
    parameters:
      - name: access_key
        description: AWS/MinIO Access Key
        required: true
        schema:
          type: string
      - name: secret_key
        description: AWS/MinIO Secret Key
        required: true
        schema:
          type: string
      - name: region
        description: AWS Region
        required: true
        schema:
          type: string
      - name: bucket_name
        description: Bucket name
        required: true
        schema:
          type: string
      - name: endpoint_url
        description: Custom endpoint URL (for MinIO)
        required: false
        schema:
          type: string
    returns:
      schema:
        type: string

  - name: bucket_request_payment
    description: Get bucket request payment configuration
    node_type: action
    parameters:
      - name: access_key
        description: AWS/MinIO Access Key
        required: true
        schema:
          type: string
      - name: secret_key
        description: AWS/MinIO Secret Key
        required: true
        schema:
          type: string
      - name: region
        description: AWS Region
        required: true
        schema:
          type: string
      - name: bucket_name
        description: Bucket name
        required: true
        schema:
          type: string
      - name: endpoint_url
        description: Custom endpoint URL (for MinIO)
        required: false
        schema:
          type: string
    returns:
      schema:
        type: string

large_image: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==
```

## src/app.py:
```python
import socket
import asyncio
import time
import random
import json
import os
import boto3
import botocore
from botocore.config import Config

from shuffle_sdk import AppBase

class AWSS3(AppBase):
    __version__ = "1.0.0"
    app_name = "AWS S3"  

    def __init__(self, redis, logger, console_logger=None):
        """
        Each app should have this __init__ to set up Redis and logging.
        :param redis:
        :param logger:
        :param console_logger:
        """
        super().__init__(redis, logger, console_logger)

    def auth_s3(self, access_key, secret_key, region, endpoint_url=None):
        """
        Authenticate to S3 or MinIO
        :param endpoint_url: Optional custom endpoint for MinIO
        """
        my_config = Config(
            region_name = region,
            signature_version = "s3v4",
            retries = {
                'max_attempts': 10,
                'mode': 'standard'
            },
        )
        
        # Build kwargs based on whether we have a custom endpoint
        kwargs = {
            'config': my_config,
            'aws_access_key_id': access_key,
            'aws_secret_access_key': secret_key,
        }
        
        # Add endpoint configuration for MinIO or custom S3
        if endpoint_url and endpoint_url.strip():
            kwargs['endpoint_url'] = endpoint_url.strip()
            # Determine if we should use SSL based on URL
            kwargs['use_ssl'] = endpoint_url.startswith('https')
            # For self-signed certificates in airgapped environments
            kwargs['verify'] = False
            
        self.s3 = boto3.resource('s3', **kwargs)
        return self.s3

    def list_buckets(self, access_key, secret_key, region, endpoint_url=None):
        """List all S3 buckets"""
        try:
            self.s3 = self.auth_s3(access_key, secret_key, region, endpoint_url)
            client = self.s3.meta.client
            newlist = client.list_buckets()
            return json.dumps(newlist, default=str)
        except botocore.exceptions.ClientError as e:
            return json.dumps({"success": False, "error": str(e)})
        except Exception as e:
            return json.dumps({"success": False, "error": str(e)})

    def create_bucket(self, access_key, secret_key, region, bucket_name, access_type, endpoint_url=None):
        """Create a new S3 bucket"""
        try:
            self.s3 = self.auth_s3(access_key, secret_key, region, endpoint_url)
            client = self.s3.meta.client
            
            # For MinIO or us-east-1, don't specify LocationConstraint
            if region == 'us-east-1' or endpoint_url:
                creation = client.create_bucket(
                    Bucket=bucket_name,
                    ACL=access_type,
                )
            else:
                creation = client.create_bucket(
                    Bucket=bucket_name,
                    ACL=access_type,
                    CreateBucketConfiguration={
                        'LocationConstraint': region
                    },
                )
            
            return json.dumps({"success": True, "result": creation}, default=str)
        except botocore.exceptions.ClientError as e:
            return json.dumps({"success": False, "error": str(e)})
        except Exception as e:
            return json.dumps({"success": False, "error": str(e)})

    def block_ip_access(self, access_key, secret_key, region, bucket_name, ip, endpoint_url=None):
        """Block IP access to bucket (AWS only, may not work with MinIO)"""
        try:
            self.s3 = self.auth_s3(access_key, secret_key, region, endpoint_url)
            client = self.s3.meta.client

            ip_policy = {
                'Effect': 'Deny',
                "Principal": "*",
                "Action": "s3:*",
                "Resource": [
                    f"arn:aws:s3:::{bucket_name}/*",
                    f"arn:aws:s3:::{bucket_name}"
                ],
                "Condition": {
                    "IpAddress": {
                        "aws:SourceIp": [ip]
                    }
                }
            }

            json_policy = {}
            try:
                result = client.get_bucket_policy(Bucket=bucket_name)
                policy = result.get("Policy", "{}")
                if ip in policy:
                    return json.dumps({"success": False, "error": f"IP {ip} is already in this policy"})
                
                json_policy = json.loads(policy)
                json_policy.setdefault("Statement", []).append(ip_policy)
            except botocore.exceptions.ClientError:
                # Create new policy if none exists
                json_policy = {
                    'Version': '2012-10-17',
                    'Statement': [ip_policy]
                }

            bucket_policy = json.dumps(json_policy)
            putaction = client.put_bucket_policy(Bucket=bucket_name, Policy=bucket_policy)
            
            return json.dumps({"success": True, "message": f"Successfully blocked IP {ip}"})
        except botocore.exceptions.ClientError as e:
            return json.dumps({"success": False, "error": str(e)})
        except Exception as e:
            return json.dumps({"success": False, "error": str(e)})

    def bucket_request_payment(self, access_key, secret_key, region, bucket_name, endpoint_url=None):
        """Get bucket request payment configuration"""
        try:
            self.s3 = self.auth_s3(access_key, secret_key, region, endpoint_url)
            client = self.s3.meta.client
            result = client.get_bucket_request_payment(Bucket=bucket_name)
            return json.dumps(result, default=str)
        except botocore.exceptions.ClientError as e:
            return json.dumps({"success": False, "error": str(e)})
        except Exception as e:
            return json.dumps({"success": False, "error": str(e)})

    def bucket_replication(self, access_key, secret_key, region, bucket_name, endpoint_url=None):
        """Get bucket replication configuration"""
        try:
            self.s3 = self.auth_s3(access_key, secret_key, region, endpoint_url)
            client = self.s3.meta.client
            result = client.get_bucket_replication(Bucket=bucket_name)
            return json.dumps(result, default=str)
        except botocore.exceptions.ClientError as e:
            return json.dumps({"success": False, "error": str(e)})
        except Exception as e:
            return json.dumps({"success": False, "error": str(e)})

    def bucket_policy_status(self, access_key, secret_key, region, bucket_name, endpoint_url=None):
        """Get bucket policy status"""
        try:
            self.s3 = self.auth_s3(access_key, secret_key, region, endpoint_url)
            client = self.s3.meta.client
            result = client.get_bucket_policy_status(Bucket=bucket_name)
            return json.dumps(result, default=str)
        except botocore.exceptions.ClientError as e:
            return json.dumps({"success": False, "error": str(e)})
        except Exception as e:
            return json.dumps({"success": False, "error": str(e)})

    def bucket_logging(self, access_key, secret_key, region, bucket_name, endpoint_url=None):
        """Get bucket logging configuration"""
        try:
            self.s3 = self.auth_s3(access_key, secret_key, region, endpoint_url)
            client = self.s3.meta.client
            result = client.get_bucket_logging(Bucket=bucket_name)
            return json.dumps(result, default=str)
        except botocore.exceptions.ClientError as e:
            return json.dumps({"success": False, "error": str(e)})
        except Exception as e:
            return json.dumps({"success": False, "error": str(e)})

    def upload_file_to_bucket(self, access_key, secret_key, region, bucket_name, bucket_path, file_id, endpoint_url=None):
        """Upload a file to S3 bucket"""
        try:
            self.s3 = self.auth_s3(access_key, secret_key, region, endpoint_url)
            client = self.s3.meta.client
            
            found_file = self.get_file(file_id)
            if not found_file:
                return json.dumps({"success": False, "error": "File not found in Shuffle"})
            
            s3_response = client.put_object(
                Bucket=bucket_name, 
                Key=bucket_path, 
                Body=found_file.get("data", "")
            )
            
            return json.dumps({"success": True, "result": s3_response}, default=str)
        except botocore.exceptions.ClientError as e:
            return json.dumps({"success": False, "error": str(e)})
        except Exception as e:
            return json.dumps({"success": False, "error": str(e)})

    def delete_file_from_bucket(self, access_key, secret_key, region, bucket_name, bucket_path, endpoint_url=None):
        """Delete a file from S3 bucket"""
        try:
            self.s3 = self.auth_s3(access_key, secret_key, region, endpoint_url)
            client = self.s3.meta.client
            
            s3_response = client.delete_object(Bucket=bucket_name, Key=bucket_path)
            return json.dumps({"success": True, "result": s3_response}, default=str)
        except botocore.exceptions.ClientError as e:
            return json.dumps({"success": False, "error": str(e)})
        except Exception as e:
            return json.dumps({"success": False, "error": str(e)})

    def download_file_from_bucket(self, access_key, secret_key, region, bucket_name, filename, endpoint_url=None):
        """Download a file from S3 bucket"""
        try:
            self.s3 = self.auth_s3(access_key, secret_key, region, endpoint_url)
            client = self.s3.meta.client
            
            s3_response_object = client.get_object(Bucket=bucket_name, Key=filename)
            object_content = s3_response_object['Body'].read()
            
            filedata = {
                "data": object_content,
                "filename": filename,
            }
            ret = self.set_files([filedata])
            
            if isinstance(ret, list) and len(ret) == 1:
                return json.dumps({
                    "success": True,
                    "file_id": ret[0],
                    "filename": filename,
                    "length": len(object_content),
                })
            
            return json.dumps({
                "success": False,
                "error": f"Failed to store file: {ret}"
            })
        except botocore.exceptions.ClientError as e:
            return json.dumps({"success": False, "error": str(e)})
        except Exception as e:
            return json.dumps({"success": False, "error": str(e)})

if __name__ == "__main__":
    AWSS3.run()
```

## Build & Deploy Instructions:
```bash
# 1. Build the Docker image
cd aws_s3
docker build -t your-registry.local:5000/shuffle/aws_s3:1.0.0 .

# 2. Push to your local registry
docker push your-registry.local:5000/shuffle/aws_s3:1.0.0

# 3. Create a ZIP for Shuffle upload (optional)
zip -r aws_s3.zip . -x "*.git*"

# 4. Upload to Shuffle via UI or API
# Go to Shuffle UI -> Apps -> Upload App -> Select aws_s3.zip

# 5. For MinIO in Kubernetes, use endpoint_url like:
# http://minio.minio-namespace.svc.cluster.local:9000
```

## Usage Example in Shuffle:
When using this app in a Shuffle workflow:
1. Add the AWS S3 app to your workflow
2. For MinIO, fill in:
   - access_key: Your MinIO access key
   - secret_key: Your MinIO secret key
   - region: us-east-1 (standard for MinIO)
   - endpoint_url: http://minio-service:9000 (your MinIO service URL)
```